%%New
%% 
clear;clc;

% %%%%%%%%%%改进DH%%%%%%%%%%%%%%%%%%%%%%%%%



% % alpha=[0,pi/2,0,0,pi/2,-pi/2];    
% % a=[0,0,-0.264,-0.237,0,0]; 
% % d=[0.144,0,0,0.1065,0.114,0.0895];  
% % thet=[0 pi/2 0 -pi/2 0 0];

alpha=[0 pi/2 0 0 -pi/2 pi/2];
a=[0 0 0.264 0.237 0 0];
d=[0.144 0 -0.0075 0.114 0.114 0.067];
thet=[0 pi/2 0 -pi/2 0 0];
dh=[alpha;a;d;thet]';



Pc(:,1) = [0.0316 -3.1464 -13.8983]*10^-3;
Pc(:,2) = [131.5620 -0.0210 112.1840]*10^-3;
Pc(:,3) = [190.3840 0.0410 17.1800]*10^-3;
Pc(:,4) = [0.0886 21.0083 -2.5014]*10^-3;
Pc(:,5) = [-0.0886 -21.0083 -2.5014]*10^-3;
Pc(:,6) = [0 0 8.0000]*10^-3;

m = [2.920; 6.787; 2.450; 1.707; 1.707; 0.176]; 
g=9.81;
Ic = zeros(3,3,6);
Ic(:,:,1)  = [42.614 0.046 0.062; 0.046 41.164 -1.386; 0.062 -1.386 31.883]*10^-4;
Ic(:,:,2)  = [100.7 -1.8 1.6; -1.8 1100.8 0; 1.6 0 1087.1]*10^-4;
Ic(:,:,3)  = [31.45 0.48 7.23; 0.48 172.41 -0.15; 7.23 -0.15 166.82]*10^-4;
Ic(:,:,4)  = [20.92 -0.061 0.078; -0.061 16.808 0.992; 0.078 0.992 19.75]*10^-4;
Ic(:,:,5)  = [20.92 -0.061 -0.078; -0.061 16.808 -0.992; -0.078 -0.992 19.75]*10^-4;
Ic(:,:,6)  = [0.9296 0 0; 0 0.9485 0; 0 0 1.5925]*10^-4; 

% q = [0;pi/3;pi/3;-pi/6;pi/2;pi/2];
% dq = [pi/2;pi/2;pi/6;0;pi/2;pi/3];
% ddq = [0,pi/34,0,pi/5,0,pi/58]';
load('Traj_10s_11.mat');
q = q';
dq = dq';
ddq = ddq';

%%%分离M&C&G思想可以参考introduction of robotic p181%%%%%%%%%

% %%%%%%%%%质心位置%%%%%%%%%%%%%%%%%%%%%%%
% Pc = sym('Pc',[3,6]);
% assume(Pc,'real');
% %%%%%%%%%%%%质量%%%%%%%%%%%%%%%%%%%%%%%
% m = sym('m',[6,1]);
% assume(m, 'real');
% syms g real;
% %%%%%%%%%%%%转动惯量%%%%%%%%%%%%%%%%%%%%
% Ic(:,:,1) = sym('Ic1',[3,3]);
% Ic(:,:,2) = sym('Ic2',[3,3]);
% Ic(:,:,3) = sym('Ic3',[3,3]);
% Ic(:,:,4) = sym('Ic4',[3,3]);
% Ic(:,:,5) = sym('Ic5',[3,3]);
% Ic(:,:,6) = sym('Ic6',[3,3]);
% assume(Ic, 'real');
% for i=1:6
%     Ic(1,2,i)=Ic(2,1,i);
%     Ic(1,3,i)=Ic(3,1,i);
%     Ic(2,3,i)=Ic(3,2,i);
% end
% 
% %%%%%%%%%%theta 数据%%%%%%%%%%%%%%%%
% q = sym('q',[6,1]);
% assume(q,'real');
% dq = sym('dq',[6,1]);
% assume(dq,'real');
% ddq = sym('ddq',[6,1]);
% assume(ddq,'real');


%% 坐标系转化
Tau = [];
for i=1:size(q,1)
[R,P] = compute_frame_transform(dh,q(i,:));
%% 计算tau
[F,N] = outsideEquation(dh,dq(i,:),ddq(i,:),Pc,m,Ic,g,R,P);
[tau] =insideEquation(dh,F,N,Pc,R,P);
Tau = [Tau;tau];
end
% %% 计算G和M
% [G,M]=calculteGandM(dh,Pc,m,Ic,g,R,P);
% %% 计算CC（离心力）
% [CC]=calculteCCandKK(dh,Pc,m,Ic,g,R,P,G);
% for i=1:6
%   Cc(:,i)=CC(:,i).*dq(i);  
% end
% %% 计算KK（科氏力）
% [KK]=calculteKK(dh,G,Pc,m,Ic,g,R,P,CC);
% %% 科氏力整理成（6X6）形式
% K1 = [0,0,0,0,0,0]';
% K2=KK*[dq(1),0,0,0,0,dq(3),dq(4),dq(5),dq(6),0,0,0,0,0,0]';
% K3 = KK*[0,dq(1),0,0,0,0,0,0,0,dq(4),dq(5),dq(6),0,0,0]';
% K4 = KK*[0,0,dq(1),0,0,0,0,0,0,0,0,0,dq(5),dq(6),0]';
% K5 = KK*[0,0,0,dq(1),0,0,0,0,0,0,0,0,0,0,dq(6)]';
% K6 = KK*[0,0,0,0,dq(1),0,0,0,0,0,0,0,0,0,0]';
% k=[K1,K2,K3,K4,K5,K6];
% %% 计算C项
% C = k + Cc;
% %% 求解tau
% Tau = M*ddq + C *dq + G;
% % save('M&C&G.mat','M','C','G');